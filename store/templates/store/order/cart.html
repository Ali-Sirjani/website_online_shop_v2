{% extends '_base.html' %}

{% load crispy_forms_filters %}
{% load product_temp_filters %}

{% block title %} cart {% endblock title %}

{% block style %}
    <style>
        .color-circle {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
    </style>
{% endblock style %}

{% block content %}

    <div class="container mt-5">
        {% if order.act_items %}

            <h2 class="mb-4">Apply Coupon</h2>
            <form method="post" class="mb-4">
                {% csrf_token %}
                {{ coupon_form.as_table }}
                <button type="submit" class="btn btn-primary">Apply Coupon</button>
            </form>

            <ul class="list-group">
                {% for item in order.act_items %}
                    <li class="list-group-item mb-3">
                        <div class="row">
                            <div class="col-md-4">
                                {% if item.product.images.all %}
                                    {% for image in item.product.images.all %}
                                        {% if image.is_main %}
                                            <img src="{{ image.image.url }}" alt="{{ item.product.title }}"
                                                 class="img-fluid">
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    <p>No image available</p>
                                {% endif %}
                            </div>
                            <div class="col-md-8">
                                <h5>{{ item.product.title }}</h5>
                                <p class="mb-1">Quantity: {{ item.quantity }}</p>
                                {% if item.color_size %}
                                    <div class="mb-1">
                                        <div class="color-circle"
                                             style="background-color: {{ item.color_size.color }};"></div>
                                        Color and Size: {{ item.color_size.color }} - {{ item.color_size.size }}
                                    </div>
                                {% endif %}
                                <p>Status: {{ item.get_track_order_display }}</p>
                                <div class="text-right">
                                    {% if item.discount %}
                                        <p class="mb-1">Price: ${{ item.price }}</p>
                                        <p class="text-danger font-weight-bold mb-1">Price:
                                            ${{ item.discount_price }}</p>
                                    {% else %}
                                        <p class="mb-1">Price: ${{ item.price }}</p>
                                    {% endif %}
                                    <p>Total (No Discount): ${{ item.get_total_no_discount_item }}</p>
                                    <p>Total (With Discount): ${{ item.get_total_with_discount_item }}</p>
                                    <p>Total Profit: ${{ item.get_total_profit_item }}</p>
                                    <p>Total: ${{ item.get_total_item }}</p>
                                    <button class="btn btn-danger btn-sm mt-2 update-cart" data-action="delete_item"
                                            data-product="{{ item.product.pk }}"
                                            data-color_size_id="{{ item.color_size.pk }}">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </li>
                {% endfor %}
            </ul>

            <div class="mt-4">
                <h4>Cart Summary</h4>
                <p>Total Items: {{ order.get_cart_items }}</p>
                <p>Cart Total (No Discount): ${{ order.get_cart_total_no_discount }}</p>
                <p>Cart Total (With Discount): ${{ order.get_cart_total_with_discount }}</p>
                <p>Cart Total Profit: ${{ order.get_cart_total_profit }}</p>
                <p>Cart Total: ${{ order.get_cart_total }}</p>
                {% if order.coupon_price %}
                    <p>Cart Total Coupon: ${{ order.coupon_price }}</p>
                    <p>Cart Total (With Coupon): ${{ order.get_cart_total_with_coupon }}</p>
                {% endif %}
                <!-- Clear Cart Button -->
                <button class="btn btn-danger mt-3 update-cart" data-action="delete_cart">Clear Cart</button>
            </div>

            <div class="text-right mb-4">
                <a href="{% url 'store:checkout' %}" class="btn btn-primary">Proceed to Checkout</a>
            </div>
        {% else %}
            <p class="mt-3">Your cart is empty.</p>
        {% endif %}
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll(".update-cart").forEach(function (button) {
                button.addEventListener("click", function () {
                    if (confirm("Are you sure you want to clear the cart?")) {
                        // Implement your logic to clear the cart
                        // You can use AJAX to communicate with your backend and update the cart accordingly
                        alert("Cart cleared!");
                    }
                });
            });
        });
    </script>

{% endblock content %}